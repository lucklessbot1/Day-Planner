<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Day Planner</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bg: '#0b0b0f',
            card: '#13131a',
            ink: '#e5e7eb',
            accent: {
              50: '#eef2ff',
              100: '#e0e7ff',
              200: '#c7d2fe',
              300: '#a5b4fc',
              400: '#818cf8',
              500: '#6366f1',
              600: '#4f46e5',
              700: '#4338ca',
              800: '#3730a3',
              900: '#312e81',
              950: '#1e1b4b',
            },
            violetx: {
              500: '#7c3aed',
              600: '#6d28d9',
              700: '#5b21b6',
            }
          },
          boxShadow: {
            glow: '0 0 0 1px rgba(99,102,241,.3), 0 8px 30px rgba(124,58,237,.15)'
          }
        }
      }
    }
  </script>
  <style>
    html, body { height: 100%; background: #0b0b0f; }
    .glass { backdrop-filter: blur(8px); background: rgba(19,19,26,.7); }
    .btn { @apply px-3 py-2 rounded-2xl shadow-glow hover:shadow-lg transition active:scale-95; }
    .chip { @apply px-2 py-1 text-xs rounded-full bg-accent-800/40 text-accent-200; }
    .input { @apply bg-card/80 border border-accent-800/30 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-violetx-600 placeholder-gray-400; }
    .tab { @apply px-3 py-2 rounded-xl hover:bg-accent-800/30; }
  </style>
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="text-ink">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <!-- Header -->
    <header class="flex items-center justify-between mb-4">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-accent-600 to-violetx-600 grid place-items-center shadow-glow">
          <i data-lucide="calendar-days" class="w-5 h-5"></i>
        </div>
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold">Day Planner</h1>
          <p id="todayLine" class="text-xs text-gray-400"></p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="signinBtn" class="btn bg-accent-700/50">Sign in</button>
        <button id="signoutBtn" class="btn bg-accent-900/50 hidden">Sign out</button>
      </div>
    </header>

    <!-- Tabs -->
    <nav class="flex gap-2 mb-4 text-sm">
      <button data-tab="today" class="tab bg-accent-900/40">Today</button>
      <button data-tab="all" class="tab">All Tasks</button>
      <button data-tab="calendar" class="tab">Calendar</button>
      <button data-tab="pomodoro" class="tab">Pomodoro</button>
      <button data-tab="notes" class="tab">Notes</button>
      <div class="ml-auto"></div>
      <input id="search" class="input text-sm w-48" placeholder="Search tasks…" />
    </nav>

    <!-- Composer -->
    <section class="glass rounded-2xl p-4 mb-4">
      <form id="taskForm" class="grid md:grid-cols-6 gap-3 items-end">
        <div class="md:col-span-2">
          <label class="text-xs text-gray-400">Title</label>
          <input class="input w-full" id="title" required placeholder="e.g., Revise DSA heaps" />
        </div>
        <div>
          <label class="text-xs text-gray-400">Due</label>
          <input type="date" class="input w-full" id="due_date" />
        </div>
        <div>
          <label class="text-xs text-gray-400">Priority</label>
          <select id="priority" class="input w-full">
            <option value="1">High</option>
            <option value="2" selected>Medium</option>
            <option value="3">Low</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-gray-400">Tags (comma)</label>
          <input id="tags" class="input w-full" placeholder="uni, ml, gym" />
        </div>
        <div>
          <button class="btn bg-violetx-600 w-full" type="submit">Add Task</button>
        </div>
        <div class="md:col-span-6">
          <label class="text-xs text-gray-400">Notes</label>
          <textarea id="notes" class="input w-full" rows="2" placeholder="Optional details…"></textarea>
        </div>
      </form>
    </section>

    <!-- Views -->
    <main>
      <!-- Today -->
      <section data-view="today" class="grid gap-4 md:grid-cols-2">
        <div class="glass rounded-2xl p-4">
          <h2 class="font-semibold mb-3 flex items-center gap-2"><i data-lucide="sunrise" class="w-4 h-4"></i>Today</h2>
          <ul id="todayList" class="space-y-2"></ul>
        </div>
        <div class="glass rounded-2xl p-4">
          <h2 class="font-semibold mb-3 flex items-center gap-2"><i data-lucide="list-todo" class="w-4 h-4"></i>Quick Stats</h2>
          <div id="stats" class="grid grid-cols-3 gap-3 text-center"></div>
        </div>
      </section>

      <!-- All -->
      <section data-view="all" class="hidden glass rounded-2xl p-4">
        <div class="flex flex-wrap gap-2 mb-3 text-xs">
          <button class="chip" data-filter="all">All</button>
          <button class="chip" data-filter="open">Open</button>
          <button class="chip" data-filter="done">Done</button>
          <button class="chip" data-filter="high">High</button>
          <button class="chip" data-filter="today">Due Today</button>
          <button class="chip" data-filter="overdue">Overdue</button>
        </div>
        <ul id="allList" class="space-y-2"></ul>
      </section>

      <!-- Calendar (very lightweight: groups by date) -->
      <section data-view="calendar" class="hidden grid md:grid-cols-2 gap-4">
        <div class="glass rounded-2xl p-4">
          <h2 class="font-semibold mb-3 flex items-center gap-2"><i data-lucide="calendar" class="w-4 h-4"></i>Upcoming (7 days)</h2>
          <div id="calendarList" class="space-y-3"></div>
        </div>
        <div class="glass rounded-2xl p-4">
          <h2 class="font-semibold mb-3 flex items-center gap-2"><i data-lucide="alarm-clock" class="w-4 h-4"></i>Reminders</h2>
          <p class="text-sm text-gray-400">Browser notifications only (local). Click to enable and we’ll ping you at task due time while the tab is open.</p>
          <button id="notifBtn" class="btn mt-3 bg-accent-800/50">Enable notifications</button>
          <ul id="reminderList" class="mt-4 text-sm space-y-2"></ul>
        </div>
      </section>

      <!-- Pomodoro -->
      <section data-view="pomodoro" class="hidden glass rounded-2xl p-4">
        <div class="grid md:grid-cols-3 gap-4 items-center">
          <div class="md:col-span-2">
            <h2 class="font-semibold mb-2 flex items-center gap-2"><i data-lucide="timer" class="w-4 h-4"></i>Pomodoro</h2>
            <div id="pomoTime" class="text-5xl font-bold">25:00</div>
            <div class="mt-3 flex gap-2">
              <button id="pomoStart" class="btn bg-violetx-600">Start</button>
              <button id="pomoPause" class="btn bg-accent-900/50">Pause</button>
              <button id="pomoReset" class="btn bg-accent-900/50">Reset</button>
              <select id="pomoMode" class="input">
                <option value="25">Focus (25)</option>
                <option value="5">Break (5)</option>
                <option value="15">Long Break (15)</option>
              </select>
            </div>
          </div>
          <div>
            <label class="text-xs text-gray-400">Link a task</label>
            <select id="pomoTask" class="input w-full"></select>
            <p id="pomoStatus" class="text-xs text-gray-400 mt-2"></p>
          </div>
        </div>
      </section>

      <!-- Notes -->
      <section data-view="notes" class="hidden glass rounded-2xl p-4">
        <h2 class="font-semibold mb-3 flex items-center gap-2"><i data-lucide="notebook-text" class="w-4 h-4"></i>Notes</h2>
        <textarea id="notesArea" class="input w-full h-48" placeholder="Daily notes…"></textarea>
        <div class="mt-3 flex gap-2">
          <button id="saveNotes" class="btn bg-violetx-600">Save</button>
          <span id="notesSaved" class="text-xs text-gray-400"></span>
        </div>
      </section>
    </main>

    <footer class="text-xs text-gray-500 mt-6 text-center">Black theme • Blue–Purple accents • Supabase powered • One-file app</footer>
  </div>

  <script>
    // ======= CONFIG =======
    const SUPABASE_URL = 'https://culhawgynzjempinargp.supabase.co'; // <- replace
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1bGhhd2d5bnpqZW1waW5hcmdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNTY3NzcsImV4cCI6MjA3MDczMjc3N30.L4jnbRIbT9yptFpEetkK_fLYPtRG2LpYjiVf7NboWO0'; // <- replace

    // ======= INIT =======
    const sb = (SUPABASE_URL.includes('YOUR-') ? null : window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY));
    const state = {
      user: null,
      tasks: [],
      notes: localStorage.getItem('notes') || '',
      filter: 'all',
      search: ''
    };

    const el = (id) => document.getElementById(id);

    // Icons
    lucide.createIcons();

    // Today line
    const today = new Date();
    const fmt = today.toLocaleString(undefined, { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' });
    el('todayLine').textContent = fmt;

    // Tabs
    document.querySelectorAll('nav [data-tab]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('nav [data-tab]').forEach(b => b.classList.remove('bg-accent-900/40'));
        btn.classList.add('bg-accent-900/40');
        const target = btn.getAttribute('data-tab');
        document.querySelectorAll('[data-view]').forEach(v => v.classList.add('hidden'));
        document.querySelector(`[data-view="${target}"]`).classList.remove('hidden');
      });
    });

    // Search
    el('search').addEventListener('input', e => { state.search = e.target.value.toLowerCase(); render(); });

    // Notes
    el('notesArea').value = state.notes;
    el('saveNotes').onclick = () => {
      state.notes = el('notesArea').value;
      localStorage.setItem('notes', state.notes);
      el('notesSaved').textContent = 'Saved locally ✓';
      setTimeout(() => el('notesSaved').textContent = '', 1500);
    };

    // Notifications (local)
    el('notifBtn').onclick = async () => {
      const perm = await Notification.requestPermission();
      if (perm !== 'granted') return alert('Notifications blocked.');
      alert('Enabled. We\'ll notify at due time while this tab is open.');
    };

    // Form submit
    el('taskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const payload = collectForm();
      let newTask = { id: crypto.randomUUID(), ...payload, completed: false, created_at: new Date().toISOString() };
      if (state.user && sb) {
        const { data, error } = await sb.from('tasks').insert({
          title: payload.title,
          notes: payload.notes,
          due_date: payload.due_date || null,
          priority: Number(payload.priority),
          tags: payload.tags,
          user_id: state.user.id
        }).select().single();
        if (error) { console.error(error); alert('Save failed, stored locally.'); }
        if (data) newTask = data;
      }
      state.tasks.unshift(newTask);
      persistLocal();
      e.target.reset();
      render();
    });

    function collectForm(){
      const title = el('title').value.trim();
      const due_date = el('due_date').value;
      const priority = el('priority').value;
      const tags = el('tags').value.split(',').map(t => t.trim()).filter(Boolean);
      const notes = el('notes').value.trim();
      return { title, due_date, priority, tags, notes };
    }

    // Renderers
    function render(){
      const q = state.search;
      const tasks = state.tasks.filter(t =>
        (!q || (t.title?.toLowerCase().includes(q) || (t.tags||[]).join(' ').toLowerCase().includes(q)))
      );

      // Stats
      const open = tasks.filter(t => !t.completed).length;
      const done = tasks.filter(t => t.completed).length;
      const todayStr = new Date().toISOString().slice(0,10);
      const dueToday = tasks.filter(t => t.due_date === todayStr && !t.completed).length;
      el('stats').innerHTML = [
        stat('Open', open),
        stat('Done', done),
        stat('Due Today', dueToday)
      ].join('');

      // Today list
      const todayTasks = tasks.filter(t => t.due_date === todayStr && !t.completed);
      el('todayList').innerHTML = todayTasks.map(row).join('') || empty('No tasks for today. Touch grass? jk. Add one.');

      // All list
      let all = tasks.slice();
      const chip = document.querySelector('[data-view="all"] .chip.active');
      const active = chip ? chip.getAttribute('data-filter') : 'all';
      filterAll(active);

      // Pomo tasks
      el('pomoTask').innerHTML = '<option value="">—</option>' + tasks.filter(t=>!t.completed).map(t=>`<option value="${t.id}">${escapeHtml(t.title)}</option>`).join('');

      // Calendar upcoming
      renderUpcoming();

      // Reminders
      renderReminders();
    }

    function stat(label, n){
      return `<div class=\"p-3 rounded-2xl bg-accent-900/30\"><div class=\"text-2xl font-bold\">${n}</div><div class=\"text-xs text-gray-400\">${label}</div></div>`;
    }

    function row(t){
      const pri = {1:'High',2:'Med',3:'Low'}[t.priority||2];
      const due = t.due_date ? new Date(t.due_date+'T00:00').toLocaleDateString() : '—';
      const tags = (t.tags||[]).map(tag=>`<span class=\"chip\">#${escapeHtml(tag)}</span>`).join(' ');
      return `<li class=\"p-3 rounded-2xl bg-card/70 border border-accent-800/30 flex items-center gap-3\">
        <input type=\"checkbox\" ${t.completed?'checked':''} onchange=\"toggleComplete('${t.id}', this.checked)\" class=\"w-4 h-4 rounded focus:ring-violetx-600\" />
        <div class=\"flex-1\">
          <div class=\"font-medium ${t.completed?'line-through text-gray-500':''}\">${escapeHtml(t.title)}</div>
          <div class=\"text-xs text-gray-400 flex flex-wrap gap-2 mt-1\">
            <span>${due}</span>
            <span class=\"chip\">${pri}</span>
            ${tags}
          </div>
        </div>
        <button class=\"btn bg-accent-900/40\" onclick=\"editTask('${t.id}')\"><i data-lucide=\"edit\" class=\"w-4 h-4\"></i></button>
        <button class=\"btn bg-accent-900/40\" onclick=\"delTask('${t.id}')\"><i data-lucide=\"trash\" class=\"w-4 h-4\"></i></button>
      </li>`;
    }

    function empty(msg){ return `<div class=\"text-sm text-gray-500\">${msg}</div>`; }

    function filterAll(which){
      const chips = document.querySelectorAll('[data-view="all"] .chip');
      chips.forEach(c=>c.classList.remove('active'));
      const target = Array.from(chips).find(c=>c.getAttribute('data-filter')===which);
      if (target) target.classList.add('active');
      const todayStr = new Date().toISOString().slice(0,10);
      let list = state.tasks.slice();
      if (which==='open') list = list.filter(t=>!t.completed);
      if (which==='done') list = list.filter(t=>t.completed);
      if (which==='high') list = list.filter(t=>(t.priority||2)==1);
      if (which==='today') list = list.filter(t=>t.due_date===todayStr);
      if (which==='overdue') list = list.filter(t=>!t.completed && t.due_date && t.due_date < todayStr);
      el('allList').innerHTML = list.map(row).join('') || empty('Nothing here.');
    }

    document.querySelectorAll('[data-view="all"] .chip').forEach(c=>{
      c.addEventListener('click', ()=> filterAll(c.getAttribute('data-filter')))
    });

    function renderUpcoming(){
      const today = new Date();
      const horizon = new Date(); horizon.setDate(today.getDate()+7);
      const map = {};
      state.tasks.forEach(t=>{
        if (!t.due_date) return;
        const d = new Date(t.due_date+'T00:00');
        if (d>=today && d<=horizon) {
          const key = t.due_date;
          (map[key] ||= []).push(t);
        }
      });
      const keys = Object.keys(map).sort();
      el('calendarList').innerHTML = keys.map(k=>{
        const ds = new Date(k+'T00:00').toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'});
        const items = map[k].map(t=> `<div class=\"flex items-center gap-2\">• <span class=\"${t.completed?'line-through text-gray-500':''}\">${escapeHtml(t.title)}</span></div>`).join('');
        return `<div><div class=\"text-sm text-accent-200\">${ds}</div><div class=\"ml-1 mt-1 space-y-1\">${items}</div></div>`;
      }).join('') || empty('No upcoming tasks.');
    }

    function renderReminders(){
      const items = state.tasks.filter(t=>t.due_date && !t.completed).slice(0,10).map(t=>{
        return `<li class=\"flex items-center justify-between bg-accent-900/20 rounded-xl p-2\"><span>${escapeHtml(t.title)}</span><button class=\"btn bg-accent-900/40\" onclick=\"pingAt('${t.id}')\">Notify at due</button></li>`;
      }).join('');
      el('reminderList').innerHTML = items || empty('Add due dates to see reminders.');
    }

    // Notify helper (tab must remain open)
    function pingAt(id){
      const t = state.tasks.find(x=>x.id===id); if (!t || !t.due_date) return;
      if (Notification.permission!== 'granted') return alert('Enable notifications first.');
      const when = new Date(t.due_date+'T09:00'); // 9 AM local
      const ms = Math.max(0, when.getTime() - Date.now());
      setTimeout(()=> new Notification('Task due', { body: t.title }), ms);
      alert('Okay okay, I\'ll remind you.');
    }

    // Task actions
    window.toggleComplete = async (id, checked) => {
      const t = state.tasks.find(x=>x.id===id);
      if (!t) return;
      t.completed = checked;
      persistLocal();
      render();
      if (state.user && sb){ await sb.from('tasks').update({ completed: checked }).eq('id', id); }
    }

    window.editTask = (id) => {
      const t = state.tasks.find(x=>x.id===id); if (!t) return;
      el('title').value = t.title; el('notes').value = t.notes||'';
      el('due_date').value = t.due_date||''; el('priority').value = String(t.priority||2);
      el('tags').value = (t.tags||[]).join(',');
      // On next submit we'll create a new row; for simple UX we delete old now
      window.delTask(id);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.delTask = async (id) => {
      state.tasks = state.tasks.filter(x=>x.id!==id);
      persistLocal();
      render();
      if (state.user && sb){ await sb.from('tasks').delete().eq('id', id); }
    }

    function persistLocal(){
      localStorage.setItem('tasks', JSON.stringify(state.tasks));
    }

    function loadLocal(){
      try { state.tasks = JSON.parse(localStorage.getItem('tasks')||'[]'); } catch { state.tasks = []; }
    }

    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    // Pomodoro
    let timer=null, secs=25*60;
    function drawPomo(){ const m=Math.floor(secs/60), s=String(secs%60).padStart(2,'0'); el('pomoTime').textContent=`${m}:${s}`; }
    el('pomoStart').onclick = ()=> { if (timer) return; timer = setInterval(()=>{ if(--secs<=0){ clearInterval(timer); timer=null; new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play(); } drawPomo(); }, 1000); };
    el('pomoPause').onclick = ()=> { clearInterval(timer); timer=null; };
    el('pomoReset').onclick = ()=> { clearInterval(timer); timer=null; secs=Number(el('pomoMode').value)*60; drawPomo(); };
    el('pomoMode').onchange = ()=> { secs=Number(el('pomoMode').value)*60; drawPomo(); };
    drawPomo();

    // Auth
    async function initAuth(){
      if (!sb) { el('signinBtn').classList.add('hidden'); return; }
      const { data: { user } } = await sb.auth.getUser();
      state.user = user; updateAuthUI();
      sb.auth.onAuthStateChange((_event, session) => { state.user = session?.user || null; updateAuthUI(); if (state.user) pullFromCloud(); });
      if (state.user) pullFromCloud();
    }

    function updateAuthUI(){
      if (state.user){ el('signinBtn').classList.add('hidden'); el('signoutBtn').classList.remove('hidden'); }
      else { el('signinBtn').classList.remove('hidden'); el('signoutBtn').classList.add('hidden'); }
    }

    el('signinBtn').onclick = async () => {
      const email = prompt('Email for magic link sign-in:'); if (!email) return;
      const { error } = await sb.auth.signInWithOtp({ email });
      if (error) alert(error.message); else alert('Check your email for the magic link.');
    };

    el('signoutBtn').onclick = async () => { await sb.auth.signOut(); };

    // Cloud sync
    async function pullFromCloud(){
      if (!state.user || !sb) return;
      const { data, error } = await sb.from('tasks').select('*').order('created_at', { ascending: false });
      if (!error && data){ state.tasks = data; persistLocal(); render(); }
    }

    // Boot
    loadLocal();
    render();
    initAuth();
  </script>
</body>
</html>
